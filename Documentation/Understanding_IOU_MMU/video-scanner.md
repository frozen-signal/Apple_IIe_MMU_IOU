# The Video Scanner
<a align="center" href="/Schematics/IOU_1.jpg">
    <img src="/resources/VideoScanner.png" style="width: 438px"/>
</a>
<p align="center"><i>IOU_1, Column 4</i></p>

> **Note:** `S5` stands for Soft 5, a 'soft' 5V; a constant HIGH signal. Comes from the Apple II.
>

## Overview

The Video Scanner is a counter that generate the horizontal and vertical positions for the display, as well as a few other signals. It is more closely related to the video display signals that generate the pixels on screen and has no direct relation to the current graphics mode.

### Video Scanner Bit Field
<div align="center">
    <img src="/resources/VideoScannerBits.png" style="width: 2597px"/>
</div>

This scanner has three parts; the Horizontal Scanner, the Vertical Scanner, and a few other timing signals. The horizontal part counts from 0 to 65. The vertical counts from 0 to 262 for NTSC, and from 0 to 312 for PAL.

### Power-On Initialization

During Power-On Initialization, `/POC` will be held LOW, and `H0`-`H5`, `VA`-`VC`, `/HPE`, and `V0`-`V5` (the video counters) are reset to 0. Once `/POC` transitions to HIGH, the counters are allowed to count up. Once these counters overflows, `TC` will pulse HIGH for one `P_PHI_2` cycle. `TC` is used in the generation of `/RESET` (See [Power-On event and /RESET Pin](reset-and-power-on.md)).
> **Note:** The counters above the video counters (`H9` and `J9`) are never initialized, and their initial value is undefined. This repository initialize these counters to 1.
>

### Operation

After `/POC` has reset the video counters to 0, and after the first overflow, the Video Scanner begins its normal operations. The counter is incremented at every rising edge of `P_PHI_2` (See FIXME Timings doc).

#### Horizontal Scanner

The bits 0 to 5 of the Video Counter are `H0` to `H5` (Horizontal Counter), and bit 6 is `/HPE` (Horizontal Preset Enable). Together, they form the Horizontal Scanner.

##### How `/HPE` works
<div align="center">
    <img src="/resources/HPE_N.png" style="width: 456px"/>
</div>

The signal `/HPE` is generated by the output of pin C of `D9`. It is also tied to the LD pin of `C9` and `D9`. In such a configuration, when `/HPE` is LOW, the values from the DATA pins are loaded (loaded at the next rising edge of `P_PHI_2`, with the values "000000" for the Horizontal Counter, and HIGH for `/HPE`). Therefore,  the signal `/HPE` is LOW only for a single `P_PHI_2` cycle, and HIGH for the remaining 64 out of the 65 cycles.

##### How the Horizontal Scanner works

First the Horizontal Counter will count up from 0 to 63. During this time, `/HPE` will be HIGH. When the Horizontal Counter overflows, `/HPE` will transition LOW and this will, at the next `P_PHI_2` cycle, load a value of 0 in the Horizontal Counter, and will set `/HPE` back to HIGH. So, the Horizontal Scanner has 65 states:
 - `/HPE` HIGH with the Horizontal Counter counting up from 0 to 63
 - `/HPE` LOW with the Horizontal Counter equal to "000000".

##### Trace of the Horizontal Scanner

<div align="center">
    <img src="/resources/HorizontalScannerTrace.png" style="width: 2597px"/>
</div>

> **Note:** Note that `PHI_0` is used instead of `P_PHI_2`. See [Differences in this implementation > Clock](#Clock)
>


#### Vertical Scanner

The bits 7, 8, and 9 of the Video Scanner are called `VA`, `VB`, and `VC` respectively. And bits 10 to 15 are signals `V0` to `V5`. Together, they are the Vertical Scanner.

##### How the Vertical Scanner works
Just like the Horizontal Counter, the counters `VA`-`VB`-`VC` and `V0`-`V5` will count up until they overflow. But unlike the Horizontal Counter, the value loaded in the Vertical Counters each time they overflow is not all-zeroes.<br/>
<br/>
`VA` is connected to its corresponding DATA pin on `D9`. This have the effect of loading its own value when `/HPE` transitions LOW. The resulting signal is a regular square wave that changes at the falling edge of `/HPE`.<br/>
<br/>
These are the load values for the other Vertical Scanner signals:

| IOU | `VB`-`VC` | `V0`-`V5` |
| --- | --- | --- |
| NTSC | 10 | 011111 |
| PAL | 00 | 011001 |

##### Trace of the Vertical Scanner

<div align="center">
    <img src="/resources/VerticalScannerTrace.png" style="width: 2632px"/>
</div>

#### `TC`

When the Vertical Scanner overflows, it will pulse HIGH `TC` for a single `P_PHI_2` cycle. This signal indicates when to load the values for the Vertical Counters. It is also used in the Power-On Initialization (See [Power-On event and /RESET Pin](reset-and-power-on.md))

#### `PAKST` and `TC1/4S`

`PAKST` is probably an acronym for _Period Any Key STrobe_. `TC1/4S` is a 1/4 second signal. Both are only used in the keyboard subsystem (See FIXME)

#### `FLASH`

`FLASH` is only used to make the text flash in the display subsystem. (See FIXME)

## Differences with this implementation

### Clock

The Emulator uses `P_PHI_2` as a clock for the Video Scanner. The implementation in this repository however, uses directly `PHI_0`. A oscilloscope probing the signals `PHI_0`, `/PRAS`, `Q3`, and `H0` of an ASIC IOU confirms that the official IOU uses `PHI_0`:

<div align="center">
    <img src="/resources/ScopeH0.png" style="width: 1024px"/>
</div>
<img src="/resources/ScopeH0Probes.svg" style="width: 320px"/>


## Experimenting with GHDL / GtkWave

To generate a trace of the Video Scanner using GDHL and GtkWave, use the following commands:

```
make clean
make import
make build
ghdl -r --workdir=work VIDEO_SCANNER_TB  --vcd=video-scanner.vcd
gtkwave video-scanner.vcd
```